datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ===== ENUMS =====

enum ROLE {
  PARTNER
  ADMIN
}

enum TransactionType {
  FLOAT
  FIXED
}

enum TransactionStatus {
  WAITING_FOR_DEPOSIT
  DEPOSITED
  IN_PROGRESS
  FINISHED
  REJECTED
  REFUNDED
}

enum V3WalletKind {
  WALLET   // /v3/{path}/wallet
  ACCOUNT  // /v3/{path}/account
}

// Протокол/тип API именно со стороны Tatum gateway
enum TatumProtocol {
  JSON_RPC
  REST
  GRPC

  INDEXER
  BEACON
  ELECTRS

  ROSSETTA
  SUBSTRATE

  TENDERMINT_RPC
  TENDERMINT_REST

  HORIZON
  SOROBAN

  TON_V2_HTTP
  TON_V3_INDEXER
}

// Зачем нам endpoint (минимально)
enum TatumEndpointRole {
  // Используется для операций, где нужен “node-like” доступ для депозитных адресов/активностей
  DEPOSIT
  // Индексер/сканер (если где-то нужен отдельно)
  INDEXER
  // Остальное (beacon, solidity, etc) — если не хочешь плодить роли
  OTHER
}

// ✅ Стратегия выдачи депозитного адреса на сети
enum DepositAddressStrategy {
  // address = f(xpub, index) — BTC/LTC/ETH/TRON и т.п.
  HD_XPUB

  // один адрес на master wallet (сознательно один и тот же)
  WALLET_SINGLE_ADDR

  // новый wallet (адрес) на каждый депозит (Algorand/Solana-стиль)
  WALLET_PER_DEPOSIT

  // один master address + уникальный memo/tag/paymentId на депозит
  SHARED_ADDR_WITH_TAG
}

// ===== USERS (AUTH) =====

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email          String? @unique
  username       String? @unique
  hashedPassword String?

  role ROLE @default(PARTNER)

  apiKey              String? @unique
  partnerTxCount      Int     @default(0)
  unwithdrawnEarnings Decimal @default(0)

  isActive Boolean @default(true)

  tokens   Token[]
  sessions Session[]

  partnerTransactions Transaction[] @relation("TransactionPartnerUser")

  @@index([role])
  @@index([email])
  @@index([username])
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User? @relation(fields: [userId], references: [id])
  userId Int?
}

model Token {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hashedToken String
  type        String
  expiresAt   DateTime
  sentTo      String

  user   User @relation(fields: [userId], references: [id])
  userId Int

  @@unique([hashedToken, type])
}

// ===== COINS =====

model Coin {
  code String @id // BTC, ETH, USDT...

  name     String
  iconUrl  String
  isActive Boolean @default(true)

  coinNetworks CoinNetwork[]

  @@index([isActive])
}

// ===== NETWORKS =====

model Network {
  id   Int    @id @default(autoincrement())
  code String @unique // "bitcoin", "ethereum", "tron", ...
  name String

  // нужен ли memo/tag/paymentId на входящем депозите (XRP/XLM и т.п.)
  requiresMemo Boolean @default(false)

  tatumLedger String

  tatumV3Path String?

  tatumChain String?

  v3WalletKind V3WalletKind @default(WALLET)

  v3SupportsXpubDerivation Boolean @default(true)

  v3BalancePathTemplate String? // например:
  // "/v3/ethereum/account/balance/{address}"
  // "/v3/{path}/address/balance/{address}"
  // "/v3/algorand/account/{address}"

  depositAddressStrategy DepositAddressStrategy @default(HD_XPUB)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coinNetworks   CoinNetwork[]
  tatumEndpoints TatumEndpoint[]
  tatumWallet    TatumWallet?

  @@index([isActive])
  @@index([tatumLedger])
  @@index([tatumV3Path])
  @@index([tatumChain])
  @@index([depositAddressStrategy])
}

// ===== MASTER WALLET PER NETWORK =====
// HD_XPUB: xpub+mnemonicEncrypted + nextDerivationIndex
// WALLET_SINGLE_ADDR / SHARED_ADDR_WITH_TAG: address+mnemonicEncrypted + nextTag
// WALLET_PER_DEPOSIT: мастер-кошелёк может быть пустым или хранить “root mnemonic”, но чаще не нужен
model TatumWallet {
  id        Int     @id @default(autoincrement())
  networkId Int     @unique
  network   Network @relation(fields: [networkId], references: [id], onDelete: Cascade)

  // HD (BTC/ETH/TRON/LTC/...)
  xpub String?

  // master address (single/shared strategies)
  address String?

  // mnemonic/secret key зашифрованный на уровне приложения
  mnemonicEncrypted String?

  // HD: следующий индекс адреса
  nextDerivationIndex Int @default(0)

  // SHARED_ADDR_WITH_TAG: следующий tag/memo/paymentId
  nextDepositTag Int @default(1)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// ===== TATUM ENDPOINTS =====

model TatumEndpoint {
  id Int @id @default(autoincrement())

  networkId Int
  network   Network @relation(fields: [networkId], references: [id], onDelete: Cascade)

  role     TatumEndpointRole
  protocol TatumProtocol

  // например: "C-Chain", "P-Chain", "X-Chain", "Algod", "Indexer", ...
  name String?

  url String

  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Не плодим одинаковые (protocol+name) в рамках одной сети
  @@unique([networkId, protocol, name])
  @@index([networkId, role, isActive])
  @@index([networkId, protocol, isActive])
  @@index([isDefault])
}

// ===== COIN <-> NETWORK =====

model CoinNetwork {
  id Int @id @default(autoincrement())

  coinCode String
  coin     Coin   @relation(fields: [coinCode], references: [code], onDelete: Restrict)

  networkId Int
  network   Network @relation(fields: [networkId], references: [id], onDelete: Restrict)

  depositEnabled  Boolean @default(true)
  withdrawEnabled Boolean @default(true)

  isDefault Boolean @default(false)

  requiresMemoOverride Boolean?

  tokenContractAddress String?
  decimals             Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coinCode, networkId])
  @@index([coinCode])
  @@index([networkId])
  @@index([isDefault])
}

// ===== SETTINGS =====

model Setting {
  id String @id @default("global")

  feeFloat Decimal @default(0)
  feeFixed Decimal @default(0)
  minFee   Decimal @default(0)

  minDeposit Decimal @default(0)
  maxDeposit Decimal @default(0)

  siteOnline Boolean @default(true)

  updatedAt DateTime @updatedAt
}

// ===== TRANSACTIONS =====

model Transaction {
  id String @id @default(uuid())

  type   TransactionType?
  status TransactionStatus

  depositCoinNetworkId Int?
  payoutCoinNetworkId  Int

  depositAmount    Decimal
  depositAmountBtc Decimal
  payoutAmount     Decimal
  payoutAmountBtc  Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ourDepositAddress      String
  ourDepositAddressExtra String?

  recipientAddress      String
  recipientAddressExtra String?

  refundAddress String?

  isPartner    Boolean
  partnerEmail String?

  partnerUserId Int?
  partnerUser   User? @relation("TransactionPartnerUser", fields: [partnerUserId], references: [id])

  finishedAt      DateTime?
  profitBtc       Decimal?
  profitRate      Decimal?
  partnerShare    Decimal?
  depositTxHash   String?
  payoutTxHash    String?
  finalSentAmount Decimal?

  // snapshot полезных полей сети на момент создания tx (чтобы изменения в Network не ломали историю)
  tatumLedger              String?
  tatumV3Path              String?
  tatumChain               String?
  depositAddressStrategy   DepositAddressStrategy?

  // HD: индекс деривации
  depositDerivationIndex Int?

  // SHARED_ADDR_WITH_TAG: tag/memo/paymentId
  depositTag String?

  @@index([status, createdAt])
  @@index([isPartner, createdAt])
  @@index([partnerUserId, createdAt])
  @@index([partnerEmail])
  @@index([depositCoinNetworkId, payoutCoinNetworkId])
  @@index([finishedAt])
  @@index([depositTxHash])
  @@index([payoutTxHash])
}
