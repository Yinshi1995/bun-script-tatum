datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ===== ENUMS =====

enum ROLE {
  PARTNER
  ADMIN
}

enum DepositAddressStrategy {
  HD_XPUB
  WALLET_SINGLE_ADDR
  WALLET_PER_DEPOSIT
  SHARED_ADDR_WITH_TAG
}

enum TransactionStatus {
  WAITING_FOR_DEPOSIT
  DEPOSITED
  IN_PROGRESS
  FINISHED
  REJECTED
  REFUNDED
}

// ===== AUTH =====

model User {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email          String? @unique
  username       String? @unique
  hashedPassword String?

  role ROLE @default(PARTNER)

  // API access (server-to-server)
  apiKey   String? @unique
  isActive Boolean @default(true)

  sessions Session[]
  tokens   Token[]

  @@index([email])
  @@index([username])
  @@index([isActive])
}

model Session {
  id                 Int       @id @default(autoincrement())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int?

  @@index([userId])
  @@index([expiresAt])
}

model Token {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hashedToken String
  type        String
  expiresAt   DateTime
  sentTo      String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId Int

  @@unique([hashedToken, type])
  @@index([userId])
  @@index([expiresAt])
}

// ===== NETWORKS =====

model Network {
  id   Int    @id @default(autoincrement())
  code String @unique   // "bitcoin", "ethereum", "tron", ...

  name String

  // XRP/XLM/etc
  requiresMemo Boolean @default(false)

  // Used directly by the script
  tatumLedger String
  tatumV3Path String?
  tatumChain  String?

  depositAddressStrategy DepositAddressStrategy @default(HD_XPUB)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tatumWallet TatumWallet?

  depositTransactions Transaction[] @relation("TxDepositNetwork")
  payoutTransactions  Transaction[] @relation("TxPayoutNetwork")

  @@index([isActive])
  @@index([tatumLedger])
  @@index([tatumV3Path])
  @@index([tatumChain])
  @@index([depositAddressStrategy])
}

// ===== MASTER WALLET (CORE FOR SCRIPT) =====

model TatumWallet {
  id        Int     @id @default(autoincrement())
  networkId Int     @unique
  network   Network @relation(fields: [networkId], references: [id], onDelete: Cascade)

  // HD wallets
  xpub String?

  // single/shared address
  address String?

  // encrypted mnemonic / secret
  mnemonicEncrypted String?

  // HD allocation
  nextDerivationIndex Int @default(0)

  // SHARED_ADDR_WITH_TAG allocation
  nextDepositTag Int @default(1)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// ===== TRANSACTIONS =====

model Transaction {
  id String @id @default(uuid())

  status TransactionStatus @default(WAITING_FOR_DEPOSIT)

  depositNetworkId Int?
  payoutNetworkId  Int

  depositNetwork Network? @relation("TxDepositNetwork", fields: [depositNetworkId], references: [id], onDelete: SetNull)
  payoutNetwork  Network  @relation("TxPayoutNetwork",  fields: [payoutNetworkId],  references: [id], onDelete: Restrict)

  depositAmount Decimal
  payoutAmount  Decimal

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  finishedAt DateTime?

  // Deposit target (generated by script)
  ourDepositAddress      String
  ourDepositAddressExtra String? // memo/tag

  // Payout target
  recipientAddress      String
  recipientAddressExtra String?

  // Blockchain tracking
  depositTxHash String?
  payoutTxHash  String?

  // Snapshot (critical for history safety)
  tatumLedger            String?
  tatumV3Path            String?
  tatumChain             String?
  depositAddressStrategy DepositAddressStrategy?
  depositDerivationIndex Int?
  depositTag             String?

  @@index([status, createdAt])
  @@index([depositNetworkId, payoutNetworkId])
  @@index([finishedAt])
  @@index([depositTxHash])
  @@index([payoutTxHash])
}
